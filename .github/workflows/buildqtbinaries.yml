name: BuildQtBinaries

on:
  workflow_dispatch:
  push:
    branches:
    # Change this to the branch name which you are developing on to trigger the workflow
    - generateqt

jobs:
  GenerateLinuxStaticBinaries:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Install dependencies
      run: |
        sudo apt-get update -q
        sudo apt-get install -q build-essential libgl1-mesa-dev libvulkan-dev ninja-build
    - name: Compile static Qt version
      run: |
        # Clone Qt6 repo
        cd ..
        git clone https://code.qt.io/qt/qt5.git -b v6.10.2
        cd qt5
        ./init-repository -f --module-subset=qtbase,qtcharts,qtsvg,qtshadertools
        # Create shadow build folder
        cd ..
        mkdir qt6_shadow
        cd qt6_shadow
        # Configure Qt6
        ../qt5/configure -static -release -prefix "../Qt6_binaries" -skip webengine -nomake tools -nomake tests -nomake examples -no-dbus -no-ssl -no-pch -opensource -confirm-license -qt-libpng -qt-pcre -- -DCMAKE_BUILD_TYPE=Release
        cmake --build . --parallel $(nproc)
        cmake --install .
    - name: Package binaries
      run: |
        tar cfvz qt6_6102_static_binaries_linux.tar.gz -C ../Qt6_binaries .
    - uses: actions/upload-artifact@v4
      with:
        name: qt6_6102_static_binaries_linux.tar.gz
        path: qt6_6102_static_binaries_linux.tar.gz
    - name: Create qt_binaries release and upload
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create qt_binaries --title "Static Qt Binaries" --notes "Pre-built static Qt 6.10.2 binaries for CI" 2>/dev/null || true
        gh release upload qt_binaries qt6_6102_static_binaries_linux.tar.gz --clobber

  GenerateMacOSStaticBinaries:
    runs-on: macos-26
    
    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Install dependencies
      run: |
        brew install ninja
    - name: Compile static Qt version
      run: |
        # Clone Qt6 repo
        cd ..
        git clone https://code.qt.io/qt/qt5.git -b v6.10.2
        cd qt5
        ./init-repository -f --module-subset=qtbase,qtcharts,qtsvg,qtshadertools
        # Create shadow build folder
        cd ..
        mkdir qt6_shadow
        cd qt6_shadow
        # Configure Qt6
        ../qt5/configure -static -release -prefix "../Qt6_binaries" -skip webengine -nomake tools -nomake tests -nomake examples -no-dbus -no-ssl -no-pch -opensource -confirm-license -- -DCMAKE_BUILD_TYPE=Release
        cmake --build . --parallel $(sysctl -n hw.ncpu)
        cmake --install .
    - name: Package binaries
      run: |
        tar cfvz qt6_6102_static_binaries_macos.tar.gz -C ../Qt6_binaries .
    - uses: actions/upload-artifact@v4
      with:
        name: qt6_6102_static_binaries_macos.tar.gz
        path: qt6_6102_static_binaries_macos.tar.gz
    - name: Upload to qt_binaries release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create qt_binaries --title "Static Qt Binaries" --notes "Pre-built static Qt 6.10.2 binaries for CI" 2>/dev/null || true
        gh release upload qt_binaries qt6_6102_static_binaries_macos.tar.gz --clobber

  GenerateWinStaticBinaries:
    runs-on: windows-2025

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Install Python 3.10 version
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        architecture: 'x64'
    - name: Install ninja
      run: |
        choco install ninja
    - name: Compile static Qt version
      run: |
        # Clone Qt6 repo
        cd ..
        git clone https://code.qt.io/qt/qt5.git -b v6.10.2
        # Create shadow build folder
        mkdir qt6_shadow
        cd qt6_shadow
        # Setup the compiler 
        cmd.exe /c "call `"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat`" && set > %temp%\vcvars.txt"
        Get-Content "$env:temp\vcvars.txt" | Foreach-Object { if ($_ -match "^(.*?)=(.*)$") { Set-Content "env:\$($matches[1])" $matches[2] } }
        # Configure Qt6 (use -init-submodules instead of perl init-repository)
        ..\qt5\configure.bat -release -static -no-pch -optimize-size -opengl desktop -platform win32-msvc -prefix "..\Qt6_binaries" -skip webengine -nomake tools -nomake tests -nomake examples -opensource -confirm-license -init-submodules -submodules qtbase,qtcharts,qtsvg,qtshadertools
        cmake --build . --parallel $env:NUMBER_OF_PROCESSORS
        cmake --install .
    - name: Package binaries
      run: |
        cd ..\Qt6_binaries
        7z a ..\mne-cpp\qt6_6102_static_binaries_win.zip .
    - uses: actions/upload-artifact@v4
      with:
        name: qt6_6102_static_binaries_win.zip
        path: qt6_6102_static_binaries_win.zip
    - name: Upload to qt_binaries release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create qt_binaries --title "Static Qt Binaries" --notes "Pre-built static Qt 6.10.2 binaries for CI" 2>$null
        gh release upload qt_binaries qt6_6102_static_binaries_win.zip --clobber

  GenerateWasmBinaries:
    runs-on: ubuntu-24.04

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Setup emscripten compiler 
      run: |
        cd ..
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        git pull
        ./emsdk install 4.0.7
        ./emsdk activate 4.0.7
    - name: Compile wasm Qt version
      run: |
        cd ..
        source ./emsdk/emsdk_env.sh
        # Clone Qt6 repo
        git clone https://code.qt.io/qt/qt5.git -b v6.10.2
        cd qt5
        ./init-repository -f --module-subset=qtbase,qtcharts,qtsvg,qtshadertools

        # Build a minimal host Qt first (required for cross-compilation)
        cd ..
        mkdir qt6_host_build
        cd qt6_host_build
        ../qt5/configure -release -prefix "$PWD/../Qt6_host" -skip webengine -nomake tools -nomake tests -nomake examples -no-dbus -no-ssl -no-pch -opensource -confirm-license -- -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF
        cmake --build . --parallel $(nproc)
        cmake --install .

        # Build WASM Qt using the host Qt
        cd ..
        mkdir qt6_shadow
        cd qt6_shadow
        ../qt5/configure -qt-host-path "$PWD/../Qt6_host" -xplatform wasm-emscripten -feature-thread -skip webengine -nomake tests -nomake examples -no-dbus -no-ssl -no-pch -opensource -confirm-license -prefix "$PWD/../Qt6_binaries" -- -DCMAKE_BUILD_TYPE=Release
        cmake --build . --parallel $(nproc)
        cmake --install .
    - name: Package binaries
      run: |
        tar cfvz qt6_6102_static_binaries_wasm.tar.gz -C ../Qt6_binaries .
    - uses: actions/upload-artifact@v4
      with:
        name: qt6_6102_static_binaries_wasm.tar.gz
        path: qt6_6102_static_binaries_wasm.tar.gz
    - name: Upload to qt_binaries release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create qt_binaries --title "Static Qt Binaries" --notes "Pre-built static Qt 6.10.2 binaries for CI" 2>/dev/null || true
        gh release upload qt_binaries qt6_6102_static_binaries_wasm.tar.gz --clobber
