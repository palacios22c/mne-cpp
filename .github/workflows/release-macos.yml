name: Release macOS

on:
  workflow_call:

jobs:
  MacOSDynamic:
    runs-on: macos-26

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Install Python 3.10 version
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        architecture: 'arm64'
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: 6.10.2
        modules: qtshadertools
    - name: Configure and compile MNE-CPP
      run: |
        ./tools/build_project.bat
    - name: Disk usage before build
      run: |
        echo "Disk usage before build:" && df -h && du -sh $HOME/*
    - name: Free up disk space before packaging
      run: |
        echo "Disk usage before cleanup:" && df -h && du -sh $HOME/*
        sudo rm -rf /usr/local/share/gtk-doc /usr/local/Cellar /usr/local/lib/node_modules /usr/share/dotnet /opt/hostedtoolcache /Users/runner/Library/Caches/*
        echo "Disk usage after cleanup:" && df -h && du -sh $HOME/*
    - name: Disk usage before packaging
      run: |
        echo "Disk usage before packaging:" && df -h && du -sh $HOME/*
    - name: Deploy binaries (MacOS)
      run: |
        ./tools/deploy.bat dynamic pack
    - name: Deploy binaries with stable release on Github
      if: startsWith(github.ref, 'refs/tags/')
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        file: mne-cpp-macos-dynamic-arm64.tar.gz
        asset_name: mne-cpp-${{ github.ref_name }}-macos-dynamic-arm64.tar.gz
        tag: ${{ github.ref }}
        overwrite: true
    - name: Deploy binaries with dev release on Github
      if: endsWith(github.ref, 'v2.0-dev') == true
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        file: mne-cpp-macos-dynamic-arm64.tar.gz
        asset_name: mne-cpp-v2.0-dev-macos-dynamic-arm64.tar.gz
        tag: dev_build
        overwrite: true


  MacOSStatic:
    runs-on: macos-26

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Install Python 3.10 version
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        architecture: 'arm64'
    - name: Install dependencies
      run: |
        brew install ninja
    - name: Cache static Qt binaries
      id: cache-qt-static
      uses: actions/cache@v4
      with:
        path: ../Qt6_static
        key: qt-6.10.2-static-macos-arm64
    - name: Download pre-built static Qt
      id: download-qt-static
      if: steps.cache-qt-static.outputs.cache-hit != 'true'
      continue-on-error: true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release download qt_binaries -p "qt6_6102_static_binaries_macos.tar.gz" -D /tmp
        mkdir -p ../Qt6_static
        tar xfz /tmp/qt6_6102_static_binaries_macos.tar.gz -C ../Qt6_static
    - name: Build static Qt from source
      if: steps.cache-qt-static.outputs.cache-hit != 'true' && steps.download-qt-static.outcome != 'success'
      run: |
        cd ..
        git clone https://code.qt.io/qt/qt5.git -b v6.10.2
        cd qt5
        ./init-repository -f --module-subset=qtbase,qtsvg,qtshadertools
        cd ..
        mkdir qt6_shadow
        cd qt6_shadow
        ../qt5/configure -static -release -prefix "$GITHUB_WORKSPACE/../Qt6_static" -skip webengine -nomake tools -nomake tests -nomake examples -no-dbus -no-ssl -no-pch -opensource -confirm-license -- -DCMAKE_BUILD_TYPE=Release
        cmake --build . --parallel $(sysctl -n hw.ncpu)
        cmake --install .
    - name: Configure and compile MNE-CPP (static)
      run: |
        export CMAKE_PREFIX_PATH=$GITHUB_WORKSPACE/../Qt6_static
        ./tools/build_project.bat static
    - name: Deploy binaries (MacOS)
      run: |
        ./tools/deploy.bat static pack
    - name: Deploy binaries with stable release on Github
      if: startsWith(github.ref, 'refs/tags/')
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        file: mne-cpp-macos-static-arm64.tar.gz
        asset_name: mne-cpp-${{ github.ref_name }}-macos-static-arm64.tar.gz
        tag: ${{ github.ref }}
        overwrite: true
    - name: Deploy binaries with dev release on Github
      if: endsWith(github.ref, 'v2.0-dev') == true
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        file: mne-cpp-macos-static-arm64.tar.gz
        asset_name: mne-cpp-v2.0-dev-macos-static-arm64.tar.gz
        tag: dev_build
        overwrite: true
