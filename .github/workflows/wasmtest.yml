name: WasmTest

on:
  push:
    branches:
    - wasm

jobs:
  WasmTest:
    runs-on: ubuntu-24.04

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -qq build-essential libgl1-mesa-dev ninja-build
    - name: Setup Emscripten
      run: |
        cd ..
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        ./emsdk install 4.0.7
        ./emsdk activate 4.0.7
    - name: Download pre-built WASM Qt binaries
      id: download-qt-wasm
      continue-on-error: true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release download qt_binaries -p 'qt6_6102_static_binaries_wasm.tar.gz' -D /tmp
    - name: Trigger BuildQtBinaries and wait
      if: steps.download-qt-wasm.outcome != 'success'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "WASM Qt binaries not found, triggering BuildQtBinaries workflow..."
        gh workflow run buildqtbinaries.yml
        # Wait for the run to appear
        sleep 10
        # Get the latest run ID for BuildQtBinaries
        RUN_ID=$(gh run list -w BuildQtBinaries -L 1 --json databaseId -q '.[0].databaseId')
        echo "Waiting for BuildQtBinaries run $RUN_ID to complete..."
        gh run watch "$RUN_ID" --interval 30
        # Retry download
        echo "Retrying download..."
        gh release download qt_binaries -p 'qt6_6102_static_binaries_wasm.tar.gz' -D /tmp
    - name: Extract WASM Qt binaries
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mkdir -p ${{ runner.tool_cache }}/Qt/6.10.2/wasm_multithread
        tar xf /tmp/qt6_6102_static_binaries_wasm.tar.gz -C ${{ runner.tool_cache }}/Qt/6.10.2/wasm_multithread
        echo "Qt6_DIR=${{ runner.tool_cache }}/Qt/6.10.2" >> $GITHUB_ENV
    - name: Download host Qt binaries for cross-compilation
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release download qt_binaries -p 'qt6_6102_static_binaries_linux.tar.gz' -D /tmp
        mkdir -p ${{ runner.tool_cache }}/Qt/6.10.2/gcc_64
        tar xf /tmp/qt6_6102_static_binaries_linux.tar.gz -C ${{ runner.tool_cache }}/Qt/6.10.2/gcc_64
    - name: Build WASM
      run: |
        source ../emsdk/emsdk_env.sh
        ./tools/wasm.sh --emsdk 4.0.7
    - name: Prepare WASM artifacts
      run: |
        # Delete folders which we do not want to ship
        rm -rf out/wasm/apps/mne_analyze_plugins
        rm -rf resources/data
        # Replace logo
        cp resources/design/logos/qtlogo.svg out/wasm/apps/qtlogo.svg
        if [ -d "out/wasm/examples" ]; then
          cp resources/design/logos/qtlogo.svg out/wasm/examples/qtlogo.svg
        fi
    - name: Setup Github credentials
      uses: fusion-engineering/setup-git-credentials@v2
      with:
        credentials: ${{secrets.GIT_CREDENTIALS_WASM_TEST}}
    - name: Update gh-pages and main branches with new wasm version
      run: |
        # Setup git credentials
        git config --global user.email christoph.dinh@mne-cpp.org
        git config --global user.name chdinh
        # Save the wasm files first
        cp -RT out/wasm/apps ../bin
        if [ -d "out/wasm/examples" ]; then
          cp -RT out/wasm/examples ../bin_examples
        fi

        # --- Update gh-pages branch ---
        git fetch origin gh-pages
        git checkout --track origin/gh-pages
        # Clean and remove all files first
        git clean -f -d
        git rm * -r
        git commit --amend -a -m 'Update wasm' --allow-empty
        # Add the saved wasm files
        cp -RT ../bin .
        if [ -d "../bin_examples" ]; then
          mkdir -p examples
          cp -RT ../bin_examples examples
        fi
        git add --all
        git commit --amend -a -m 'Update wasm'
        git push origin gh-pages -f

        # --- Update main branch ---
        git checkout main 2>/dev/null || git checkout -b main
        git clean -f -d
        git rm -rf --ignore-unmatch .
        git commit --allow-empty -m 'Update wasm'
        cp -RT ../bin .
        if [ -d "../bin_examples" ]; then
          mkdir -p examples
          cp -RT ../bin_examples examples
        fi
        git add --all
        git commit --amend -m 'Update wasm'
        git push -f origin main