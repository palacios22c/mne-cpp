name: Release

on:
  push:
    tags:
    - v0.*
    branches:
    - v2.0-dev

jobs:
  CreateRelease:
    runs-on: ubuntu-24.04

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Create new branch with the tag's name (stable release only)
      if: endsWith(github.ref, 'v2.0-dev') == false
      run: |
        currentVersionPatch=`echo ${GITHUB_REF#refs/tags/} | cut -d. -f3`
        # Only branch off if we have a new minor version bump, which will always result in the patch version to be 0
        if [[ "$currentVersionPatch" == 0 ]]; then
          echo Branching off $currentVersionPatch
          # Setup Git
          git config --global user.email christoph.dinh@mne-cpp.org
          git config --global user.name chdinh
          # Create new branch named after the new version tag
          git checkout -b ${GITHUB_REF#refs/tags/}
          git push origin refs/heads/${GITHUB_REF#refs/tags/}
        fi
    - name: Update dev_build tag and release (dev release only)
      if: endsWith(github.ref, 'v2.0-dev') == true
      timeout-minutes: 5
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -x  # Enable debug output
        
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # Configure git to use GITHUB_TOKEN
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}
        
        # Delete current dev_build release remotely (if it exists)
        echo "Attempting to delete existing dev_build release..."
        if gh release view dev_build > /dev/null 2>&1; then
          gh release delete dev_build --yes --cleanup-tag
          echo "Existing release deleted."
        else
          echo "No existing dev_build release found, skipping deletion."
        fi
        
        # Delete current tag remotely (if it exists)
        echo "Attempting to delete existing dev_build tag..."
        git push origin :refs/tags/dev_build 2>/dev/null || echo "Tag did not exist remotely, continuing."
        
        # Change dev_build tag to point to newest commit
        git tag dev_build -f -a -m "Development Builds"
        
        # Send the new tag
        git push origin dev_build -f
        
        # Create new dev_build release
        echo "Creating new dev_build release..."
        gh release create dev_build --prerelease --title "Development Builds" --notes "Development Builds"
        echo "Release created successfully."

  # Platform-specific build workflows (run in parallel)
  Linux:
    needs: CreateRelease
    uses: ./.github/workflows/release-linux.yml
    secrets: inherit

  MacOS:
    needs: CreateRelease
    uses: ./.github/workflows/release-macos.yml
    secrets: inherit

  Windows:
    needs: CreateRelease
    uses: ./.github/workflows/release-windows.yml
    secrets: inherit

  # Cross-platform jobs
  Tests:
    # Only run for dev releases
    if: endsWith(github.ref, 'v2.0-dev') == true
    runs-on: ubuntu-24.04
    needs: CreateRelease

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Clone mne-cpp test data
      run: git clone https://github.com/mne-tools/mne-cpp-test-data.git resources/data/mne-cpp-test-data
    - name: Install Python 3.10 version
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        architecture: 'x64'
    - name: Install Codecov
      run: |
        sudo pip install codecov
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: 6.10.2
        modules: qtcharts qt3d qtshadertools
    - name: Configure and compile MNE-CPP
      run: |
        ./tools/build_project.bat coverage all
    - name: Run tests and upload results to Codecov
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        QTEST_FUNCTION_TIMEOUT: 900000
      run: |
        ./tools/test_all.bat verbose withCoverage

  Doxygen:
    runs-on: ubuntu-24.04
    needs: CreateRelease

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Install Qt Dev Tools, Doxygen and Graphviz
      run: |
        sudo apt-get update -qq
        sudo apt-get install -qq qttools5-dev-tools doxygen graphviz
    - name: Run Doxygen and package result
      run: |
        git fetch --all
        git checkout origin/main
        cd doc/doxygen
        doxygen mne-cpp_doxyfile
    - name: Setup Github credentials
      uses: fusion-engineering/setup-git-credentials@v2
      with:
        credentials: ${{secrets.GIT_CREDENTIALS}}
    - name: Deploy qch docu data base with stable release on Github
      if: startsWith(github.ref, 'refs/tags/')
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: doc/doxygen/qt-creator_doc/mne-cpp.qch
        asset_name: mne-cpp-${{ github.ref_name }}-doc-qtcreator.qch
        tag: ${{ github.ref }}
        overwrite: true
    - name: Deploy qch docu data base with dev release on Github
      if: endsWith(github.ref, 'v2.0-dev') == true
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: doc/doxygen/qt-creator_doc/mne-cpp.qch
        asset_name: mne-cpp-v2.0-dev-doc-qtcreator.qch
        tag: dev_build
        overwrite: true
    # TODO: Uncomment when chdinh has access to mne-cpp organization
    # - name: Update documentation at Github pages
    #   env:
    #     GIT_CREDENTIALS: ${{ secrets.GIT_CREDENTIALS }}
    #   run: |
    #     cd doc/doxygen
    #     git config --global user.email christoph.dinh@mne-cpp.org
    #     git config --global user.name chdinh
    #     git clone -b gh-pages "https://${GIT_CREDENTIALS}@github.com/mne-cpp/doxygen-api" gh-pages
    #     cd gh-pages
    #     # Remove all files first
    #     git rm * -r
    #     git commit --amend -a -m 'Update docu' --allow-empty
    #     touch .nojekyll
    #     # Copy doxygen files
    #     cp -r ../html/* .
    #     # Add all new files, commit and push
    #     git add *
    #     git add .nojekyll
    #     git commit --amend -a -m 'Update docu'
    #     git push -f --all

  # TODO: Uncomment when chdinh has access to mne-cpp organization
  # gh-pages:
  #   # Only run for dev releases
  #   if: endsWith(github.ref, 'v2.0-dev') == true
  #   runs-on: ubuntu-24.04
  #   needs: CreateRelease
  #
  #   steps:
  #   - name: Clone repository
  #     uses: actions/checkout@v3
  #   - name: Setup Github credentials
  #     uses: fusion-engineering/setup-git-credentials@v2
  #     with:
  #       credentials: ${{secrets.GIT_CREDENTIALS}}
  #   - name: Clone doc/gh-pages into gh-pages branch
  #     env:
  #       GIT_CREDENTIALS: ${{ secrets.GIT_CREDENTIALS }}
  #     run: |
  #       git config --global user.email christoph.dinh@mne-cpp.org
  #       git config --global user.name chdinh
  #       # Clone using credentials embedded in URL
  #       git clone -b main --single-branch "https://${GIT_CREDENTIALS}@github.com/mne-cpp/mne-cpp.github.io.git"
  #       cd mne-cpp.github.io
  #       # Remove all files first
  #       git rm * -r
  #       git commit --amend -a -m 'Update docu' --allow-empty
  #       cd ..
  #       cp -RT doc/gh-pages mne-cpp.github.io
  #       cd mne-cpp.github.io
  #       git add .
  #       git commit --amend -a -m 'Update docu'
  #       git push -f --all

  WebAssembly:
    # Only run for dev releases
    if: endsWith(github.ref, 'v2.0-dev') == true
    runs-on: ubuntu-24.04
    needs: CreateRelease

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    # Note: Qt 6.10.2 WASM exists but isn't yet available via aqt. Using 6.8.0 for now.
    # When aqt supports 6.10.2, update version and emsdk to 4.0.7
    - name: Install Qt Desktop and WASM
      run: |
        pip install 'aqtinstall>=3.3'
        # Install desktop Qt (needed as host for WASM cross-compilation)
        aqt install-qt linux desktop 6.8.0 linux_gcc_64 --outputdir ${{ runner.tool_cache }}/Qt --modules qtcharts qt3d qtshadertools
        # Install WASM Qt (qt3d not available for WASM)
        aqt install-qt all_os wasm 6.8.0 wasm_multithread --outputdir ${{ runner.tool_cache }}/Qt --modules qtcharts qtshadertools
        # Qt6_DIR should point to the parent (6.8.0/) because wasm.sh appends wasm_multithread/bin/qt-cmake
        echo "Qt6_DIR=${{ runner.tool_cache }}/Qt/6.8.0" >> $GITHUB_ENV
    - name: Setup and build WASM
      run: |
        ./tools/wasm.sh --emsdk 3.1.56
    # TODO: Uncomment when chdinh has access to mne-cpp organization
    # - name: Setup Github credentials
    #   uses: fusion-engineering/setup-git-credentials@v2
    #   with:
    #     credentials: ${{secrets.GIT_CREDENTIALS}}
    # - name: Clone and update mne-cpp/wasm:gh-pages
    #   env:
    #     GIT_CREDENTIALS: ${{ secrets.GIT_CREDENTIALS }}
    #   run: |
    #     # Delete folders which we do not want to ship
    #     rm -r out/wasm/apps/mne_analyze_plugins
    #     rm -r resources/data
    #     # Replace logo
    #     cp -RT resources/design/logos/qtlogo.svg bin/qtlogo.svg
    #     # Clone repo and update with new wasm versions
    #     git config --global user.email christoph.dinh@mne-cpp.org
    #     git config --global user.name chdinh
    #     git clone -b gh-pages --single-branch "https://${GIT_CREDENTIALS}@github.com/mne-cpp/wasm.git"
    #     cd wasm
    #     # Remove all files first
    #     git rm * -r
    #     git commit --amend -a -m 'Update wasm builds' --allow-empty
    #     # Copy wasm files
    #     cd ..
    #     cp -RT out/wasm/apps wasm
    #     cd wasm
    #     git add .
    #     git commit --amend -a -m 'Update wasm builds'
    #     git push -f --all
