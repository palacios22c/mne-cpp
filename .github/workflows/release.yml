name: Linux|MacOS|Win|WASM

on:
  push:
    tags:
      - "v0.*"
    branches:
      - "v2.0-dev"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.10"
  QT_VERSION: "6.10.2"
  QT_MODULES: "qtcharts qt3d qtshadertools"

  # Your identity for commits to gh-pages repos
  GIT_USER_NAME: "chdinh"
  GIT_USER_EMAIL: "christoph.dinh@mne-cpp.org"

jobs:
  CreateRelease:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create new branch with the tag's name (stable release only)
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF#refs/tags/}"
          patch="$(echo "$tag" | cut -d. -f3)"

          if [[ "$patch" == "0" ]]; then
            echo "Branching off tag $tag"
            git config user.email "${GIT_USER_EMAIL}"
            git config user.name  "${GIT_USER_NAME}"
            git checkout -b "$tag"
            git push origin "refs/heads/$tag"
          else
            echo "Patch != 0 -> no branch created"
          fi

      - name: Update dev_build tag and release (dev branch only)
        if: github.ref == 'refs/heads/v2.0-dev'
        timeout-minutes: 10
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          git config user.email "${GIT_USER_EMAIL}"
          git config user.name  "${GIT_USER_NAME}"

          # Ensure git uses GITHUB_TOKEN for THIS repo only
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}"

          # Delete existing dev_build release if present
          if gh release view dev_build >/dev/null 2>&1; then
            gh release delete dev_build --yes --cleanup-tag
          fi

          # Ensure remote tag is removed (ignore if missing)
          git push origin :refs/tags/dev_build || true

          # Recreate annotated tag on current commit
          git tag -f -a dev_build -m "Development Builds"
          git push -f origin dev_build

          # Recreate prerelease
          gh release create dev_build \
            --prerelease \
            --title "Development Builds" \
            --notes "Development Builds"

  LinuxDynamic:
    runs-on: ubuntu-24.04
    needs: CreateRelease
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Init required submodules
        shell: bash
        run: |
          set -euo pipefail
          git submodule update --init src/applications/mne_scan/plugins/brainflowboard/brainflow
          git submodule update --init src/applications/mne_scan/plugins/lsladapter/liblsl

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          modules: ${{ env.QT_MODULES }}

      - name: Build BrainFlow submodule
        shell: bash
        run: |
          set -euo pipefail
          cd src/applications/mne_scan/plugins/brainflowboard/brainflow
          mkdir -p build
          cd build
          cmake -DCMAKE_INSTALL_PREFIX=../installed -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-Wno-deprecated-declarations" ..
          cmake --build . --config Release

      - name: Build LSL submodule
        shell: bash
        run: |
          set -euo pipefail
          cd src/applications/mne_scan/plugins/lsladapter/liblsl
          mkdir -p build
          cd build
          cmake -DCMAKE_INSTALL_PREFIX=../installed -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-Wno-deprecated-declarations" ..
          cmake --build . --config Release

      - name: Build MNE-CPP
        shell: bash
        run: |
          set -euo pipefail
          ./tools/build_project.bat

      - name: Package
        shell: bash
        run: |
          set -euo pipefail
          ./tools/deploy.bat dynamic pack

      - name: Upload stable release asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mne-cpp-linux-dynamic-x86_64.tar.gz
          asset_name: mne-cpp-linux-dynamic-x86_64.tar.gz
          tag: ${{ github.ref_name }}
          overwrite: true

      - name: Upload dev_build asset
        if: github.ref == 'refs/heads/v2.0-dev'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mne-cpp-linux-dynamic-x86_64.tar.gz
          asset_name: mne-cpp-linux-dynamic-x86_64-v2.0-dev.tar.gz
          tag: dev_build
          overwrite: true

  MacOSDynamic:
    runs-on: macos-26
    needs: CreateRelease
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: "arm64"
          cache: "pip"

      - name: Init required submodules
        shell: bash
        run: |
          set -euo pipefail
          git submodule update --init src/applications/mne_scan/plugins/brainflowboard/brainflow
          git submodule update --init src/applications/mne_scan/plugins/lsladapter/liblsl

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          modules: ${{ env.QT_MODULES }}

      - name: Build BrainFlow submodule
        shell: bash
        run: |
          set -euo pipefail
          cd src/applications/mne_scan/plugins/brainflowboard/brainflow
          mkdir -p build
          cd build
          cmake -DCMAKE_INSTALL_PREFIX=../installed -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-Wno-deprecated-declarations" ..
          cmake --build . --config Release

      - name: Build LSL submodule
        shell: bash
        run: |
          set -euo pipefail
          cd src/applications/mne_scan/plugins/lsladapter/liblsl
          mkdir -p build
          cd build
          cmake -DCMAKE_INSTALL_PREFIX=../installed -DCMAKE_BUILD_TYPE=Release ..
          cmake --build . --config Release

      - name: Build MNE-CPP
        shell: bash
        run: |
          set -euo pipefail
          ./tools/build_project.bat

      - name: Package
        shell: bash
        run: |
          set -euo pipefail
          ./tools/deploy.bat dynamic pack

      - name: Upload stable release asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mne-cpp-macos-dynamic-x86_64.tar.gz
          asset_name: mne-cpp-macos-dynamic-x86_64.tar.gz
          tag: ${{ github.ref_name }}
          overwrite: true

      - name: Upload dev_build asset
        if: github.ref == 'refs/heads/v2.0-dev'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mne-cpp-macos-dynamic-x86_64.tar.gz
          asset_name: mne-cpp-macos-dynamic-x86_64-v2.0-dev.tar.gz
          tag: dev_build
          overwrite: true

  WinDynamic:
    runs-on: windows-2025
    needs: CreateRelease
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: "x64"
          cache: "pip"

      - name: Init required submodules
        shell: bash
        run: |
          set -euo pipefail
          git submodule update --init src/applications/mne_scan/plugins/brainflowboard/brainflow
          git submodule update --init src/applications/mne_scan/plugins/lsladapter/liblsl

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: win64_msvc2022_64
          modules: ${{ env.QT_MODULES }}

      - name: Build BrainFlow submodule (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $path = "src\applications\mne_scan\plugins\brainflowboard\brainflow\src\board_controller\muse\muse_bglib\muse_bglib_helper.cpp"
          $txt = "#include <chrono>`r`n" + [System.IO.File]::ReadAllText($path)
          [System.IO.File]::WriteAllText($path, $txt)

          cd src\applications\mne_scan\plugins\brainflowboard\brainflow
          New-Item -ItemType Directory -Force -Path build | Out-Null
          cd build
          cmake -G "Visual Studio 17 2022" -A x64 -DMSVC_RUNTIME=dynamic -DCMAKE_SYSTEM_VERSION=10.0 -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\applications\mne_scan\plugins\brainflowboard\brainflow\installed" ..
          cmake --build . --target install --config Release

      - name: Build LSL submodule (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cd src\applications\mne_scan\plugins\lsladapter\liblsl
          New-Item -ItemType Directory -Force -Path build | Out-Null
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release --target install

      - name: Build MNE-CPP (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cmd.exe /c "call `"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat`" && set > %temp%\vcvars.txt"
          Get-Content "$env:temp\vcvars.txt" | ForEach-Object {
            if ($_ -match "^(.*?)=(.*)$") { Set-Content "env:\$($matches[1])" $matches[2] }
          }
          ./tools/build_project.bat

      - name: Package (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          ./tools/deploy.bat dynamic pack

      - name: Upload stable release asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mne-cpp-windows-dynamic-x86_64.zip
          asset_name: mne-cpp-windows-dynamic-x86_64.zip
          tag: ${{ github.ref_name }}
          overwrite: true

      - name: Upload dev_build asset
        if: github.ref == 'refs/heads/v2.0-dev'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mne-cpp-windows-dynamic-x86_64.zip
          asset_name: mne-cpp-windows-dynamic-x86_64-v2.0-dev.zip
          tag: dev_build
          overwrite: true

  Tests:
    if: github.ref == 'refs/heads/v2.0-dev'
    runs-on: ubuntu-24.04
    needs: CreateRelease
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone test data
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 https://github.com/mne-tools/mne-cpp-test-data.git resources/data/mne-cpp-test-data

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Codecov uploader
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          pip install codecov

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          modules: ${{ env.QT_MODULES }}

      - name: Build coverage
        shell: bash
        run: |
          set -euo pipefail
          ./tools/build_project.bat coverage all

      - name: Run tests and upload results to Codecov
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
          QTEST_FUNCTION_TIMEOUT: "900000"
        shell: bash
        run: |
          set -euo pipefail
          ./tools/test_all.bat verbose withCoverage

  Doxygen:
    runs-on: ubuntu-24.04
    needs: CreateRelease
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -qq qttools5-dev-tools doxygen graphviz

      - name: Generate Doxygen
        shell: bash
        run: |
          set -euo pipefail
          git fetch --all
          git checkout origin/main
          cd doc/doxygen
          doxygen mne-cpp_doxyfile

      - name: Upload qch to stable release
        if: startsWith(github.ref, 'refs/tags/')
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: doc/doxygen/qt-creator_doc/mne-cpp.qch
          asset_name: mne-cpp-doc-qtcreator.qch
          tag: ${{ github.ref_name }}
          overwrite: true

      - name: Upload qch to dev_build
        if: github.ref == 'refs/heads/v2.0-dev'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: doc/doxygen/qt-creator_doc/mne-cpp.qch
          asset_name: mne-cpp-doc-qtcreator-v2.0-dev.qch
          tag: dev_build
          overwrite: true

      - name: Setup git credentials (classic PAT)
        if: github.ref == 'refs/heads/v2.0-dev'
        uses: fusion-engineering/setup-git-credentials@v2
        with:
          credentials: ${{ secrets.GIT_CREDENTIALS }}

      - name: Publish Doxygen HTML to mne-cpp/doxygen-api:gh-pages
        if: github.ref == 'refs/heads/v2.0-dev'
        shell: bash
        run: |
          set -euo pipefail
          cd doc/doxygen

          git config user.email "${GIT_USER_EMAIL}"
          git config user.name  "${GIT_USER_NAME}"

          git clone --single-branch --branch gh-pages https://github.com/mne-cpp/doxygen-api.git gh-pages

          cd gh-pages
          git rm -r --ignore-unmatch .
          touch .nojekyll
          cp -r ../html/* .
          git add -A
          git commit -m "Update docu" || true
          git push -f origin gh-pages

  gh-pages:
    if: github.ref == 'refs/heads/v2.0-dev'
    runs-on: ubuntu-24.04
    needs: CreateRelease
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup git credentials (classic PAT)
        uses: fusion-engineering/setup-git-credentials@v2
        with:
          credentials: ${{ secrets.GIT_CREDENTIALS }}

      - name: Publish doc/gh-pages to mne-cpp.github.io:main
        shell: bash
        run: |
          set -euo pipefail

          git config user.email "${GIT_USER_EMAIL}"
          git config user.name  "${GIT_USER_NAME}"

          git clone --single-branch --branch main https://github.com/mne-cpp/mne-cpp.github.io.git

          cd mne-cpp.github.io
          git rm -r --ignore-unmatch .
          git commit --allow-empty -m "Update docu" || true
          cd ..

          cp -RT doc/gh-pages mne-cpp.github.io

          cd mne-cpp.github.io
          git add -A
          git commit -m "Update docu" || true
          git push -f origin main

  WebAssembly:
    if: github.ref == 'refs/heads/v2.0-dev'
    runs-on: ubuntu-24.04
    needs: CreateRelease
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt Desktop
        uses: jurplel/install-qt-action@v3
        with:
          aqtversion: "==3.1.*"
          py7zrversion: ">=0.20.2"
          version: "6.8.0"
          host: "linux"
          target: "desktop"
          arch: "gcc_64"
          modules: "qtcharts qt3d qtshadertools"

      - name: Install Qt WASM
        uses: jurplel/install-qt-action@v3
        with:
          aqtversion: "==3.1.*"
          py7zrversion: ">=0.20.2"
          version: "6.8.0"
          host: "linux"
          target: "desktop"
          arch: "wasm_multithread"
          modules: "qtcharts qt3d qtshadertools"

      - name: Build WASM
        shell: bash
        run: |
          set -euo pipefail
          ./tools/wasm.sh --emsdk 3.1.25

      - name: Setup git credentials (classic PAT)
        uses: fusion-engineering/setup-git-credentials@v2
        with:
          credentials: ${{ secrets.GIT_CREDENTIALS }}

      - name: Publish to mne-cpp/wasm:gh-pages
        shell: bash
        run: |
          set -euo pipefail

          rm -rf out/wasm/apps/mne_analyze_plugins
          rm -rf resources/data
          cp -RT resources/design/logos/qtlogo.svg bin/qtlogo.svg

          git config user.email "${GIT_USER_EMAIL}"
          git config user.name  "${GIT_USER_NAME}"

          git clone --single-branch --branch gh-pages https://github.com/mne-cpp/wasm.git wasm

          cd wasm
          git rm -r --ignore-unmatch .
          cd ..

          cp -RT out/wasm/apps wasm

          cd wasm
          git add -A
          git commit -m "Update wasm builds" || true
          git push -f origin gh-pages
