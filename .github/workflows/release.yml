name: Release

on:
  push:
    tags:
    - v0.*
    branches:
    - v2.0-dev

jobs:
  CreateRelease:
    runs-on: ubuntu-24.04

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Create new branch with the tag's name (stable release only)
      if: endsWith(github.ref, 'v2.0-dev') == false
      run: |
        currentVersionPatch=`echo ${GITHUB_REF#refs/tags/} | cut -d. -f3`
        # Only branch off if we have a new minor version bump, which will always result in the patch version to be 0
        if [[ "$currentVersionPatch" == 0 ]]; then
          echo Branching off $currentVersionPatch
          # Setup Git
          git config --global user.email christoph.dinh@mne-cpp.org
          git config --global user.name chdinh
          # Create new branch named after the new version tag
          git checkout -b ${GITHUB_REF#refs/tags/}
          git push origin refs/heads/${GITHUB_REF#refs/tags/}
        fi
    - name: Update dev_build tag and release (dev release only)
      if: endsWith(github.ref, 'v2.0-dev') == true
      timeout-minutes: 5
      env:
        GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
      run: |
        set -x  # Enable debug output
        
        git config --global user.email christoph.dinh@mne-cpp.org
        git config --global user.name chdinh
        
        # Configure git to use token
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}
        
        # Delete current dev_build release remotely (if it exists)
        echo "Attempting to delete existing dev_build release..."
        if gh release view dev_build > /dev/null 2>&1; then
          gh release delete dev_build --yes --cleanup-tag
          echo "Existing release deleted."
        else
          echo "No existing dev_build release found, skipping deletion."
        fi
        
        # Delete current tag remotely (if it exists)
        echo "Attempting to delete existing dev_build tag..."
        git push origin :refs/tags/dev_build 2>/dev/null || echo "Tag did not exist remotely, continuing."
        
        # Change dev_build tag to point to newest commit
        git tag dev_build -f -a -m "Development Builds"
        
        # Send the new tag
        git push origin dev_build -f
        
        # Create new dev_build release (use --target to avoid tag propagation race)
        echo "Creating new dev_build release..."
        gh release create dev_build --prerelease --title "Development Builds" --notes "Development Builds" --target ${{ github.sha }}
        echo "Release created successfully."

  # Platform-specific build workflows (run in parallel)
  Linux:
    needs: CreateRelease
    uses: ./.github/workflows/release-linux.yml
    secrets: inherit

  MacOS:
    needs: CreateRelease
    uses: ./.github/workflows/release-macos.yml
    secrets: inherit

  Windows:
    needs: CreateRelease
    uses: ./.github/workflows/release-windows.yml
    secrets: inherit

  # Build installers AFTER all platform releases have been uploaded.
  # Downloads the release archives from GitHub Releases and packages them
  # with the Qt Installer Framework.
  Installer:
    needs: [Linux, MacOS, Windows]
    uses: ./.github/workflows/release-installer.yml
    secrets: inherit

  # Cross-platform jobs (Tests are handled by testci.yml)
  Doxygen:
    runs-on: ubuntu-24.04
    needs: CreateRelease

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Install Qt Dev Tools, Doxygen and Graphviz
      run: |
        sudo apt-get update -qq
        sudo apt-get install -qq qttools5-dev-tools doxygen graphviz
    - name: Run Doxygen and package result
      run: |
        git fetch --all
        git checkout origin/main
        cd doc/doxygen
        doxygen mne-cpp_doxyfile
    - name: Setup Github credentials
      uses: fusion-engineering/setup-git-credentials@v2
      with:
        credentials: ${{secrets.GIT_CREDENTIALS}}
    - name: Deploy qch docu data base with stable release on Github
      if: startsWith(github.ref, 'refs/tags/')
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        file: doc/doxygen/qt-creator_doc/mne-cpp.qch
        asset_name: mne-cpp-${{ github.ref_name }}-doc-qtcreator.qch
        tag: ${{ github.ref }}
        overwrite: true
    - name: Deploy qch docu data base with dev release on Github
      if: endsWith(github.ref, 'v2.0-dev') == true
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        file: doc/doxygen/qt-creator_doc/mne-cpp.qch
        asset_name: mne-cpp-v2.0-dev-doc-qtcreator.qch
        tag: dev_build
        overwrite: true
    - name: Update documentation at Github pages
      env:
        GIT_CREDENTIALS: ${{ secrets.GIT_CREDENTIALS }}
      run: |
        cd doc/doxygen
        git config --global user.email christoph.dinh@mne-cpp.org
        git config --global user.name chdinh
        git clone -b gh-pages "https://${GIT_CREDENTIALS}@github.com/mne-cpp/doxygen-api" gh-pages
        cd gh-pages
        # Remove all files first
        git rm * -r
        git commit --amend -a -m 'Update docu' --allow-empty
        touch .nojekyll
        # Copy doxygen files
        cp -r ../html/* .
        # Add all new files, commit and push
        git add *
        git add .nojekyll
        git commit --amend -a -m 'Update docu'
        git push -f --all

  gh-pages:
    # Only run for dev releases
    if: endsWith(github.ref, 'v2.0-dev') == true
    runs-on: ubuntu-24.04
    needs: CreateRelease
  
    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Setup Github credentials
      uses: fusion-engineering/setup-git-credentials@v2
      with:
        credentials: ${{secrets.GIT_CREDENTIALS}}
    - name: Clone doc/gh-pages into gh-pages branch
      env:
        GIT_CREDENTIALS: ${{ secrets.GIT_CREDENTIALS }}
      run: |
        git config --global user.email christoph.dinh@mne-cpp.org
        git config --global user.name chdinh
        # Clone using credentials embedded in URL
        git clone -b main --single-branch "https://${GIT_CREDENTIALS}@github.com/mne-cpp/mne-cpp.github.io.git"
        cd mne-cpp.github.io
        # Remove all files first
        git rm * -r
        git commit --amend -a -m 'Update docu' --allow-empty
        cd ..
        cp -RT doc/gh-pages mne-cpp.github.io
        cd mne-cpp.github.io
        git add .
        git commit --amend -a -m 'Update docu'
        git push -f --all

  WebAssembly:
    # Only run for dev releases
    if: endsWith(github.ref, 'v2.0-dev') == true
    runs-on: ubuntu-24.04
    needs: CreateRelease

    steps:
    - name: Clone repository
      uses: actions/checkout@v3
    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -qq build-essential libgl1-mesa-dev ninja-build
    - name: Setup Emscripten
      run: |
        cd ..
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        ./emsdk install 4.0.7
        ./emsdk activate 4.0.7
    - name: Download pre-built WASM Qt binaries
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release download qt_binaries -p 'qt6_6102_static_binaries_wasm.tar.gz' -D /tmp
        mkdir -p ${{ runner.tool_cache }}/Qt/6.10.2/wasm_multithread
        tar xf /tmp/qt6_6102_static_binaries_wasm.tar.gz -C ${{ runner.tool_cache }}/Qt/6.10.2/wasm_multithread
        echo "Qt6_DIR=${{ runner.tool_cache }}/Qt/6.10.2" >> $GITHUB_ENV
    - name: Download host Qt binaries for cross-compilation
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release download qt_binaries -p 'qt6_6102_static_binaries_linux.tar.gz' -D /tmp
        mkdir -p ${{ runner.tool_cache }}/Qt/6.10.2/gcc_64
        tar xf /tmp/qt6_6102_static_binaries_linux.tar.gz -C ${{ runner.tool_cache }}/Qt/6.10.2/gcc_64
    - name: Build WASM
      run: |
        source ../emsdk/emsdk_env.sh
        ./tools/wasm.sh --emsdk 4.0.7
    - name: Prepare WASM artifacts
      run: |
        # Delete folders which we do not want to ship
        rm -rf out/wasm/apps/mne_analyze_plugins
        rm -rf resources/data
        # Replace logo
        cp resources/design/logos/qtlogo.svg out/wasm/apps/qtlogo.svg
        if [ -d "out/wasm/examples" ]; then
          cp resources/design/logos/qtlogo.svg out/wasm/examples/qtlogo.svg
        fi
    - name: Package WASM build as tar.gz
      run: |
        tar cfz mne-cpp-wasm.tar.gz -C out/wasm .
    - name: Deploy WASM tar.gz with dev release on Github
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        file: mne-cpp-wasm.tar.gz
        asset_name: mne-cpp-v2.0-dev-wasm.tar.gz
        tag: dev_build
        overwrite: true
    - name: Setup Github credentials
      uses: fusion-engineering/setup-git-credentials@v2
      with:
        credentials: ${{secrets.GIT_CREDENTIALS}}
    - name: Clone and update mne-cpp/wasm repository
      env:
        GIT_CREDENTIALS: ${{ secrets.GIT_CREDENTIALS }}
      run: |
        git config --global user.email christoph.dinh@mne-cpp.org
        git config --global user.name chdinh
        git clone "https://${GIT_CREDENTIALS}@github.com/mne-cpp/wasm.git" wasm-repo
        cd wasm-repo

        # --- Update gh-pages branch ---
        if git rev-parse --verify origin/gh-pages > /dev/null 2>&1; then
          git checkout gh-pages
        else
          git checkout --orphan gh-pages
        fi
        git rm -rf --ignore-unmatch .
        git clean -f -d
        git commit --allow-empty -m 'Update wasm builds'
        # Copy apps to root
        cp -RT ../out/wasm/apps .
        # Copy examples to examples/ subdirectory
        if [ -d "../out/wasm/examples" ]; then
          mkdir -p examples
          cp -RT ../out/wasm/examples examples
        fi
        git add .
        git commit --amend -m 'Update wasm builds'
        git push -f origin gh-pages

        # --- Update main branch ---
        if git rev-parse --verify origin/main > /dev/null 2>&1; then
          git checkout main
        else
          git checkout --orphan main
        fi
        git rm -rf --ignore-unmatch .
        git clean -f -d
        git commit --allow-empty -m 'Update wasm builds'
        # Copy apps to root
        cp -RT ../out/wasm/apps .
        # Copy examples to examples/ subdirectory
        if [ -d "../out/wasm/examples" ]; then
          mkdir -p examples
          cp -RT ../out/wasm/examples examples
        fi
        git add .
        git commit --amend -m 'Update wasm builds'
        git push -f origin main
